storage:
  image: ubuntu:latest
  container_name: gfdrr_storage
  hostname: storage
  volumes:
    # These are sharable to other containers
    - ./settings:/home/settings
    - /home/import_done
    - /home/import_queue
    - /home/cache
    #- ./import_done:/home/import_done
    #- ./import_queue:/home/import_queue
    #- ./cache:/home/cache

dbosm:
  # About the postgresql version, it should match in the dockerfile of docker-imposm3
  image: kartoza/postgis:9.4-2.1
  container_name: gfdrr_dbosm
  hostname: dbosm
  environment:
    - USERNAME=docker
    - PASS=docker
  volumes_from:
    - storage
  ports:
   - "54333:5432"

osmdbbackups:
  # Note you cannot scale if you use conteiner_name
  container_name: gfdrr_osm-db-backups
  image: kartoza/pg-backup:9.4
  hostname: pg-backups
  volumes:
    - ./osmdb_backups:/backups
  links:
    - dbosm:dbosm
  environment:
    # take care to let the project name below match that
    # declared in the top of the makefile
    - DUMPPREFIX=PG_gfdrrosm
    # These are all defaults anyway, but setting explicitly in
    # case we ever want to ever use different credentials
    - PGUSER=docker
    - PGPASSWORD=docker
    - PGPORT=5432
    - PGHOST=dbosm
    - PGDATABASE=gis
  restart: always

gfdrrdbbackups:
  # Note you cannot scale if you use conteiner_name
  container_name: gfdrr_dbgfdrr-db-backups
  image: kartoza/pg-backup:9.4
  hostname: pg-backups
  volumes:
    - ./gfdrrdb_backups:/backups
  links:
    - dbgfdrr:dbgfdrr
  environment:
    # take care to let the project name below match that
    # declared in the top of the makefile
    - DUMPPREFIX=PG_dbgfdrr
    # These are all defaults anyway, but setting explicitly in
    # case we ever want to ever use different credentials
    - PGUSER=docker
    - PGPASSWORD=docker
    - PGPORT=5432
    - PGHOST=dbgfdrr
    - PGDATABASE=gis
  restart: always

imposm:
  build: docker-imposm3
  container_name: gfdrr_imposm
  volumes_from:
    - storage
  links:
    - dbosm:dbosm
  environment:
    - USER=docker
    - PASSWORD=docker
    - PORT=5432
    - HOST=dbosm
    - DATABASE=gis
    # seconds between 2 executions of the script
    - TIME=120
    # folder for settings (with *.json and *.sql)
    - SETTINGS=settings
    # folder for caching
    - CACHE=cache
    # folder for diff which has been imported
    - IMPORT_DONE=import_done
    # folder for diff which hasn't been imported yet
    - IMPORT_QUEUE=import_queue
    # it can be 3857
    - SRID=4326
    # see http://imposm.org/docs/imposm3/latest/tutorial.html#optimize
    - OPTIMIZE=false
    # see http://imposm.org/docs/imposm3/latest/tutorial.html#deploy-production-tables
    - DBSCHEMA_PRODUCTION=public
    # http://imposm.org/docs/imposm3/latest/tutorial.html#deploy-production-tables
    - DBSCHEMA_IMPORT=import
    # http://imposm.org/docs/imposm3/latest/tutorial.html#deploy-production-tables
    - DBSCHEMA_BACKUP=backup
    # Install some styles if you are using the default mapping. It can be 'yes' or 'no'
    - QGIS_STYLE=yes
    # Use clip in the database
    - CLIP=no


osmupdate:
  build: docker-osmupdate
  container_name: gfdrr_osmupdate
  volumes_from:
    - storage
  environment:
    # These are all currently the defaults but listed here for your
    # convenience if you want to change them
    # the maximum time range to assamble a cumulated changefile.
    - MAX_DAYS=100
    # osmupdate uses a combination of minutely, hourly and daily changefiles. This value can be minute, hour, day or sporadic.
    - DIFF=sporadic
    # argument to determine the maximum number of parallely processed changefiles.
    - MAX_MERGE=7
    # define level for gzip compression. values between 1 (low compression but fast) and 9 (high compression but slow)
    - COMPRESSION_LEVEL=1
    # change the URL to use a custom URL to fetch regional file updates.
    - BASE_URL=http://planet.openstreetmap.org/replication/
    # folder for diff which hasn't been imported yet
    - IMPORT_QUEUE=import_queue
    # folder for diff which has been imported
    - IMPORT_DONE=import_done
    # seconds between 2 executions of the script
    - TIME=120

dbgfdrr:
  image: kartoza/postgis:9.4-2.1
  container_name: gfdrr_oondra-dbgfdrr
  hostname: dbgfdrr
  volumes:
    - ./pg/postgres_data:/var/lib/postgresql
  environment:
    - USERNAME=docker
    - PASS=docker
  ports:
    - "6113:5432"

geonode:
  build: docker-geonode
  container_name: gfdrr_oondra-geonode
  hostname: geonode
  volumes:
    - ./logs:/var/log/
    - ./geoserver_data:/geonode/geoserver/data
  ports:
    - "8111:8000"
    - "8181:8080"
  links:
    - dbgfdrr:dbgfdrr
    - dbosm:dbosm
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=dbgfdrr
    # osm-db links
    - USER=docker
    - PASSWORD=docker
    - PORT=5432
    - HOST=dbosm  
    - DATABASE=gis

